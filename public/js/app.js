var Analyser=function(){"use strict";var e,t={id:"analyser"},o=32,r=o/2,n=-.01,a=-200,i=.8,c=$("#analyser")[0],l=c.getContext("2d"),d=c.width,s=c.height,u=12,p=Math.round(d/u),v=255/s,f=new Uint8Array(r),m=l.createLinearGradient(0,0,0,100);return m.addColorStop(1,"#0B8468"),m.addColorStop(.75,"#40C46D"),m.addColorStop(.25,"#C8D621"),m.addColorStop(0,"#CC1126"),l.fillStyle=m,t.create=function(e){return t.context=e,t.analyserNode=t.context.createAnalyser(),t.fftSize=o,t.frequencyBinCount=r,t.maxDecibels=n,t.minDecibels=a,t.smoothingTimeConstant=i,t.firstNode=t.analyserNode,t.lastNode=t.analyserNode,t},t.connect=function(e){t.destination=e,t.lastNode.connect(t.destination)},t.disconnect=function(){t.lastNode.disconnect()},t.startSpectrum=function(){t.analyserNode.getByteFrequencyData(f),l.clearRect(0,0,d,s);for(var o=0;p>o;o++){var r=f[o]/v;l.fillRect(u*o,s,u-2,-r)}e=requestAnimationFrame(t.startSpectrum)},t.stopSpectrum=function(){l.clearRect(0,0,d,s),cancelAnimationFrame(e)},t}(),Bitcrusher=function(){"use strict";function e(e){for(var o=e.inputBuffer.getChannelData(0),r=e.outputBuffer.getChannelData(0),n=0,a=0,i=Math.pow(.5,t.bitrate),c=0;c<t.bufferSize;c++)n+=t.normFreq,n>=1&&(n-=1,a=i*Math.floor(o[c]/i+.5)),r[c]=a}var t={id:"bitcrusher",bufferSizes:[256,512,1024,2048,4096],bufferSize:2048,bitrate:2,normFreq:1},o=1;return t.create=function(r){return t.context=r,t.crusherNode=t.context.createScriptProcessor(t.bufferSize,o,o),t.crusherNode.onaudioprocess=e,t.firstNode=t.crusherNode,t.lastNode=t.crusherNode,t},t.connect=function(e){t.destination=e,t.lastNode.connect(t.destination)},t.disconnect=function(){t.lastNode.disconnect()},t.updateBuffer=function(e){t.bufferSize=t.bufferSizes[e-1]},t.updateBitrate=function(e){t.bitrate=e},t}(),Compressor=function(){"use strict";var e={id:"compressor"};return e.create=function(t){return e.context=t,e.dynamicsCompressorNode=e.context.createDynamicsCompressor(),e.firstNode=e.dynamicsCompressorNode,e.lastNode=e.dynamicsCompressorNode,e},e.connect=function(t){e.destination=t,e.lastNode.connect(e.destination)},e.disconnect=function(){e.lastNode.disconnect()},e.updateAttack=function(t){e.dynamicsCompressorNode.attack.value=t},e.updateKnee=function(t){e.dynamicsCompressorNode.knee.value=t},e.updateRatio=function(t){e.dynamicsCompressorNode.ratio.value=t},e.updateReduction=function(t){e.dynamicsCompressorNode.reduction.value=t},e.updateRelease=function(t){e.dynamicsCompressorNode.release.value=t},e.updateThreshold=function(t){e.dynamicsCompressorNode.threshold.value=t},e}(),Delay=function(){"use strict";var e={id:"delay"},t=3;return e.create=function(o){return e.context=o,e.levelNode=e.context.createGain(),e.delayNode=e.context.createDelay(t),e.delayNode.delayTime.value=.5,e.delayGainNode=e.context.createGain(),e.delayGainNode.gain.value=.5,e.levelNode.connect(e.delayNode),e.delayNode.connect(e.delayGainNode),e.delayGainNode.connect(e.levelNode),e.firstNode=e.levelNode,e.lastNode=e.levelNode,e},e.connect=function(t){e.destination=t,e.lastNode.connect(e.destination)},e.disconnect=function(){e.lastNode.disconnect()},e.updateLevel=function(t){e.levelNode.gain.value=t},e.updateTime=function(t){e.delayNode.delayTime.value=t},e.updateGain=function(t){e.delayGainNode.gain.value=t},e}(),Keyboard=function(){"use strict";{var e={};new Array(256)}return e.create=function(){return e},e.noteOn=function(){},e.noteOff=function(){},e}();$(function(){"use strict";function e(){a.play($("#oscillator #modType").val(),$("#oscillator #carrierType").val(),$("#oscillator #modFrequency").val(),$("#oscillator #carrierFrequency").val(),$("#oscillator #modDetune").val(),$("#oscillator #modGain").val(),$("#oscillator #carrierGain").val())}function t(){a.stop(),a.create(o)}var o={};try{window.AudioContext=window.AudioContext||window.webkitAudioContext,o=new AudioContext,window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame}catch(r){alert("This application is not supported by this browser!\nCurrently supports <strong>Chrome</strong>")}var n=Keyboard.create(),a=Oscillator.create(o),i=Waveshaper.create(o),c=Bitcrusher.create(o),l=Reverb.create(o),d=Delay.create(o),s=Compressor.create(o),u=Mixer.create(o),p=Analyser.create(o);Router.setup(o,[a,i,c,l,d,s,u,p]);var v=!1;$("#oscillator #power").on("click",function(){v?($(this).removeClass("active"),t(),v=!1,p.stopSpectrum()):($(this).addClass("active"),e(),Router.rerouteOsc(),v=!0,p.startSpectrum())}),$("#oscillator #modType").on("change",function(){a.updateModType($(this).val())}),$("#oscillator #modFrequency").on("input",function(){a.updateModFrequency($(this).val())}),$("#oscillator #modDetune").on("input",function(){a.updateModDetune($(this).val())}),$("#oscillator #modGain").on("input",function(){a.updateModGain($(this).val())}),$("#oscillator #carrierType").on("change",function(){a.updateCarrierType($(this).val())}),$("#oscillator #carrierFrequency").on("input",function(){a.updateCarrierFrequency($(this).val())}),$("#oscillator #carrierGain").on("input",function(){a.updateCarrierGain($(this).val())});var f=!1;$("#waveshaper #power").on("click",function(){f?($(this).removeClass("active"),f=!1,Router.unroute(i)):($(this).addClass("active"),f=!0,Router.route(i),i.updateGain($("#waveshaper #gain").val()),i.updateCurve($("#waveshaper #drive").val()),i.updateTone($("#waveshaper #tone").val()))}),$("#waveshaper #gain").on("input",function(){i.updateGain($(this).val())}),$("#waveshaper #drive").on("input",function(){i.updateCurve($(this).val())}),$("#waveshaper #tone").on("input",function(){i.updateTone($(this).val())});var m=!1;$("#bitcrusher #power").on("click",function(){m?($(this).removeClass("active"),m=!1,Router.unroute(c)):($(this).addClass("active"),m=!0,Router.route(c))}),$("#bitcrusher #buffer").on("change",function(){c.updateBuffer($(this).val())}),$("#bitcrusher #bitrate").on("input",function(){c.updateBitrate($(this).val())});var N=!1;$("#reverb #power").on("click",function(){N?($(this).removeClass("active"),N=!1,Router.unroute(reverb)):($(this).addClass("active"),N=!0,Router.route(reverb))}),$("#reverb #time").on("input",function(){l.updateTime($(this).val())}),$("#reverb #decay").on("input",function(){l.updateDecay($(this).val())});var h=!1;$("#reverb #reverse").on("click",function(){h?($(this).removeClass("active"),h=!1,l.updateReverse()):($(this).addClass("active"),h=!0,l.updateReverse(h))});var y=!1;$("#delay #power").on("click",function(){y?($(this).removeClass("active"),y=!1,Router.unroute(d)):($(this).addClass("active"),y=!0,Router.route(d))}),$("#delay #level").on("input",function(){d.updateLevel($(this).val())}),$("#delay #time").on("input",function(){d.updateTime($(this).val())}),$("#delay #delayLevel").on("input",function(){d.updateGain($(this).val())});var w=!1;$("#compressor #power").on("click",function(){w?($(this).removeClass("active"),w=!1,Router.unroute(s)):($(this).addClass("active"),w=!0,Router.route(s))}),$("#compressor #attack").on("input",function(){s.updateAttack($(this).val())}),$("#compressor #knee").on("input",function(){s.updateKnee($(this).val())}),$("#compressor #ratio").on("input",function(){s.updateRatio($(this).val())}),$("#compressor #reduction").on("input",function(){s.updateReduction($(this).val())}),$("#compressor #release").on("input",function(){s.updateRelease($(this).val())}),$("#compressor #threshold").on("input",function(){s.updateThreshold($(this).val())}),$("#mixer #equalizer #low").on("input",function(){u.updateLow($(this).val())}),$("#mixer #equalizer #middle").on("input",function(){u.updateMiddle($(this).val())}),$("#mixer #equalizer #high").on("input",function(){u.updateHigh($(this).val())}),$("#mixer #pan").on("input",function(){u.updatePanner($(this).val())}),$("#mixer #volume").on("input",function(){u.updateVolume($(this).val())});var g={},x=$("#presets #patch");$.getJSON("presets.json",function(e){g=e.presets;var t=1;for(var o in g)x.append($("<option />").val(t).text(g[o].name)),t++}),$("#presets #patch").on("change",function(){var o=g[$(this).val()-1];$("#oscillator #modType").val(a.waveTypes.indexOf(o.oscillator.modType)+1),$("#oscillator #modFrequency").val(o.oscillator.modFrequency),$("#oscillator #modDetune").val(o.oscillator.modDetune),$("#oscillator #modGain").val(o.oscillator.modGain),$("#oscillator #carrierType").val(a.waveTypes.indexOf(o.oscillator.carrierType)+1),$("#oscillator #carrierFrequency").val(o.oscillator.carrierFrequency),$("#oscillator #carrierGain").val(o.oscillator.carrierGain),!v&&o.oscillator.power?$("#oscillator #power").click():v&&o.oscillator.power?(t(),e(),Router.rerouteOsc()):$("#oscillator #power").click(),(!f&&o.waveshaper.power||f&&!o.waveshaper.power)&&$("#waveshaper #power").click(),$("#waveshaper #gain").val(o.waveshaper.gain).trigger("input"),$("#waveshaper #drive").val(o.waveshaper.drive).trigger("input"),$("#waveshaper #tone").val(o.waveshaper.tone).trigger("input"),(!m&&o.bitcrusher.power||m&&!o.bitcrusher.power)&&$("#bitcrusher #power").click(),$("#bitcrusher #buffer").val(c.bufferSizes.indexOf(o.bitcrusher.buffer)+1).trigger("change"),$("#bitcrusher #bitrate").val(o.bitcrusher.bitrate).trigger("input"),(!N&&o.reverb.power||N&&!o.reverb.power)&&$("#reverb #power").click(),$("#reverb #time").val(o.reverb.time).trigger("input"),$("#reverb #decay").val(o.reverb.decay).trigger("input"),(!h&&o.reverb.reverse||h)&&$("#reverb #reverse").click(),(!y&&o.delay.power||y&&!o.delay.power)&&$("#delay #power").click(),$("#delay #level").val(o.delay.level).trigger("input"),$("#delay #time").val(o.delay.time).trigger("input"),$("#delay #delayLevel").val(o.delay.delayLevel).trigger("input"),(!w&&o.compressor.power||w&&!o.compressor.power)&&$("#compressor #power").click(),$("#compressor #attack").val(o.compressor.attack).trigger("input"),$("#compressor #knee").val(o.compressor.knee).trigger("input"),$("#compressor #ratio").val(o.compressor.ratio).trigger("input"),$("#compressor #reduction").val(o.compressor.reduction).trigger("input"),$("#compressor #release").val(o.compressor.release).trigger("input"),$("#compressor #threshold").val(o.compressor.threshold).trigger("input"),$("#mixer #low").val(o.mixer.low).trigger("input"),$("#mixer #middle").val(o.mixer.middle).trigger("input"),$("#mixer #high").val(o.mixer.high).trigger("input"),$("#mixer #pan").val(o.mixer.pan).trigger("input"),$("#mixer #volume").val(o.mixer.volume).trigger("input")}),$("input").on("dblclick",function(){$(this).val($(this).attr("value")).trigger("input")}),$(window).on("keydown",function(e){switch(e.keyCode){case 32:$("#oscillator #power").click();break;case 27:v&&$("#oscillator #power").click(),f&&$("#waveshaper #power").click(),m&&$("#bitcrusher #power").click(),N&&$("#reverb #power").click(),y&&$("#delay #power").click(),w&&$("#compressor #power").click()}}),$(window).on("keydown",function(e){e.keyCode>=65&&e.keyCode<=89&&n.noteOn(e.keyCode)}),$(window).on("keyup",function(e){e.keyCode>=65&&e.keyCode<=89&&n.noteOff(e.keyCode)})});var Mixer=function(){"use strict";var e={id:"mixer"},t=200,o=1e3,r=2e3;return e.create=function(n){return e.context=n,e.lowFilterNode=e.context.createBiquadFilter(),e.lowFilterNode.type="lowshelf",e.lowFilterNode.frequency.value=t,e.middleFilterNode=e.context.createBiquadFilter(),e.middleFilterNode.type="peaking",e.middleFilterNode.frequency.value=o,e.highFilterNode=e.context.createBiquadFilter(),e.highFilterNode.type="highshelf",e.highFilterNode.frequency.value=r,e.channelMergerNode=e.context.createChannelMerger(2),e.pannerNode=e.context.createPanner(),e.pannerNode.panningModel="equalpower",e.levelNode=e.context.createGain(),e.lowFilterNode.connect(e.middleFilterNode),e.middleFilterNode.connect(e.highFilterNode),e.highFilterNode.connect(e.channelMergerNode,0,0),e.highFilterNode.connect(e.channelMergerNode,0,1),e.channelMergerNode.connect(e.pannerNode),e.pannerNode.connect(e.levelNode),e.firstNode=e.lowFilterNode,e.lastNode=e.levelNode,e},e.connect=function(t){e.destination=t,e.lastNode.connect(e.destination)},e.updateLow=function(t){e.lowFilterNode.gain.value=t},e.updateMiddle=function(t){e.middleFilterNode.gain.value=t},e.updateHigh=function(t){e.highFilterNode.gain.value=t},e.updatePanner=function(t){e.pannerNode.setPosition(t,0,0)},e.updateVolume=function(t){e.levelNode.gain.value=t},e}(),Oscillator=function(){"use strict";var e={id:"oscillator",waveTypes:["sine","square","sawtooth","triangle"],attack:.1,sustain:0},t=!1;return e.create=function(t){return e.context=t,e.modOscillatorNode=e.context.createOscillator(),e.modGainNode=e.context.createGain(),e.carrierOscillatorNode=e.context.createOscillator(),e.carrierGainNode=e.context.createGain(),e.modOscillatorNode.connect(e.modGainNode),e.modGainNode.connect(e.carrierOscillatorNode.frequency),e.carrierOscillatorNode.connect(e.carrierGainNode),e.firstNode=e.modOscillatorNode,e.lastNode=e.carrierGainNode,e},e.connect=function(t){e.destination=t,e.lastNode.connect(e.destination)},e.disconnect=function(){e.lastNode.disconnect()},e.play=function(o,r,n,a,i,c,l){t||(e.modOscillatorNode=e.context.createOscillator(),e.modOscillatorNode.type=o,e.modOscillatorNode.frequency.value=n,e.modOscillatorNode.detune.value=i,e.modGainNode=e.context.createGain(),e.modGainNode.gain.value=c,e.carrierOscillatorNode=e.context.createOscillator(),e.carrierOscillatorNode.type=r,e.carrierOscillatorNode.frequency.value=a,e.carrierGainNode=e.context.createGain(),e.carrierGainNode.gain.cancelScheduledValues(e.context.currentTime),e.carrierGainNode.gain.setValueAtTime(0,e.context.currentTime),e.carrierGainNode.gain.linearRampToValueAtTime(l,e.context.currentTime+e.attack),e.modOscillatorNode.connect(e.modGainNode),e.modGainNode.connect(e.carrierOscillatorNode.frequency),e.carrierOscillatorNode.connect(e.carrierGainNode),e.firstNode=e.modOscillatorNode,e.lastNode=e.carrierGainNode,e.modOscillatorNode.start(0),e.carrierOscillatorNode.start(0),t=!0)},e.stop=function(){t&&(e.carrierGainNode.gain.value=0,e.modOscillatorNode.stop(0),e.carrierOscillatorNode.stop(0),e.modOscillatorNode=null,e.modGainNode=null,e.carrierOscillatorNode=null,e.carrierGainNode=null,t=!1)},e.updateModType=function(t){e.modOscillatorNode.type=e.waveTypes[t-1]},e.updateModFrequency=function(t){e.modOscillatorNode.frequency.value=t},e.updateModDetune=function(t){e.modOscillatorNode.detune.value=t},e.updateModGain=function(t){e.modGainNode.gain.value=t},e.updateCarrierType=function(t){e.carrierOscillatorNode.type=e.waveTypes[t-1]},e.updateCarrierFrequency=function(t){e.carrierOscillatorNode.frequency.value=t},e.updateCarrierGain=function(t){e.carrierGainNode.gain.value=t},e}(),Reverb=function(){"use strict";function e(){for(var e=t.context.sampleRate,o=e*t.time,r=t.decay,n=t.context.createBuffer(2,o,e),a=n.getChannelData(0),i=n.getChannelData(1),c=0;o>c;c++){var l=t.reverse?o-c:c;a[c]=(2*Math.random()-1)*Math.pow(1-l/o,r),i[c]=(2*Math.random()-1)*Math.pow(1-l/o,r)}t.convolverNode.buffer=n}var t={id:"reverb",time:3,decay:2,reverse:!1};return t.create=function(o){return t.context=o,t.convolverNode=t.context.createConvolver(),e(),t.firstNode=t.convolverNode,t.lastNode=t.convolverNode,t},t.connect=function(e){t.destination=e,t.lastNode.connect(t.destination)},t.disconnect=function(){t.lastNode.disconnect()},t.updateTime=function(o){t.time=o,e()},t.updateDecay=function(o){t.decay=o,e()},t.updateReverse=function(o){t.reverse=o,e()},t}(),Router=function(){"use strict";function e(e){for(var t={input:0,output:0},o=e-1;o>=0;o--)if(r[o]){t.input=o;break}for(var n=e+1;n<r.length;n++)if(r[n]){t.output=n;break}return t}var t,o=[],r=[],n=function(e,n){t=e,o=n,r=new Array(o.length);for(var a=0;a<r.length;a++)r[a]=!1;o[0].connect(o[6].firstNode),r[0]=!0,o[6].connect(o[7].firstNode),r[6]=!0,o[7].connect(t.destination),r[7]=!0},a=function(n){for(var a=0;a<o.length;a++)if(o[a].id===n.id){var i=e(a);o[a].create(t),o[i.input].disconnect(),o[i.input].connect(o[a].firstNode),o[a].connect(o[i.output].firstNode),r[a]=!0;break}},i=function(){var t=e(0);o[0].disconnect(),o[0].connect(o[t.output].firstNode)},c=function(t){for(var n=0;n<o.length;n++)if(o[n].id===t.id){var a=e(n);o[a.input].disconnect(),o[n].disconnect(),o[a.input].connect(o[a.output].firstNode),r[n]=!1;break}};return{setup:n,route:a,rerouteOsc:i,unroute:c}}(),Waveshaper=function(){"use strict";function e(e){for(var t=50*e,o=44100,r=new Float32Array(o),n=Math.PI/180,a=0;o>a;a++){var i=2*a/o-1;r[a]=(3+t)*i*20*n/(Math.PI+t*Math.abs(i))}return r}var t={id:"waveshaper"};return t.create=function(e){return t.context=e,t.gainNode=t.context.createGain(),t.waveShaperNode=t.context.createWaveShaper(),t.lowPassFilterNode=t.context.createBiquadFilter(),t.lowPassFilterNode.type="lowpass",t.gainNode.connect(t.waveShaperNode),t.waveShaperNode.connect(t.lowPassFilterNode),t.firstNode=t.gainNode,t.lastNode=t.lowPassFilterNode,t},t.connect=function(e){t.destination=e,t.lastNode.connect(t.destination)},t.disconnect=function(){t.lastNode.disconnect()},t.updateGain=function(e){t.gainNode.gain.value=e},t.updateCurve=function(o){var r=e(o);t.waveShaperNode.curve=r},t.updateTone=function(e){t.lowPassFilterNode.frequency.value=e},t}();